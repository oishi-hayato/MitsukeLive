<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MitsukeLive - 2D Object Detection Demo</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  </head>
  <body>
    <div id="app"></div>

    <script type="module">
      import * as MitsukeLive from "../dist/index.js";

      const { createApp, ref, onMounted, onUnmounted } = Vue;

      // Constants
      const FLASH_CONFIG = {
        interval: 200,
        count: 3,
        color: "#00ff88",
        lineWidth: 3,
      };

      const MODEL_PATHS = {
        modelPath: "models/model.json",
        metadataPath: "models/metadata.yaml",
      };

      const MESSAGES = {
        INITIALIZING: "Initializing...",
        CAMERA_INIT: "Initializing camera...",
        READY: "Please scan an object",
        DETECTION_COMPLETE: "Detection complete - Click ▶️ to resume",
        PAUSED: "Detection paused",
        CAMERA_DENIED: "Camera access denied",
      };

      const DetectionApp = {
        setup() {
          const state = {
            status: ref(MESSAGES.INITIALIZING),
            detectionInfo: ref(null),
            error: ref(""),
            isDetecting: ref(false),
          };

          let detector = null;

          // Format detection information
          const formatDetectionInfo = (detection) => {
            if (!detection) return null;

            return {
              score: (detection.score * 100).toFixed(1),
              box: detection.boundingBox?.map((v) => Math.round(v)) || [
                0, 0, 0, 0,
              ],
              centerX: detection.center2D?.x
                ? Math.round(detection.center2D.x)
                : 0,
              centerY: detection.center2D?.y
                ? Math.round(detection.center2D.y)
                : 0,
            };
          };

          // Handle detection
          const handleDetection = async (detection) => {
            if (!state.isDetecting.value) return;

            if (detection) {
              // Update detection information
              state.detectionInfo.value = formatDetectionInfo(detection);

              // Flash effect
              await MitsukeLive.startFlashEffect(
                document.getElementById("canvas"),
                detection,
                FLASH_CONFIG
              );

              // Pause detection and update state
              detector.pause();
              state.isDetecting.value = false;
              state.status.value = MESSAGES.DETECTION_COMPLETE;
            }
            // For 2D demo, do nothing on detection failure (conventional behavior)
          };

          // Initialize detector
          const initDetector = async () => {
            try {
              state.status.value = MESSAGES.CAMERA_INIT;

              if (!MitsukeLive) {
                throw new Error("MitsukeLive library is not loaded");
              }

              const options = {
                onCameraReady: () => {
                  state.status.value = MESSAGES.READY;
                },
                onDetection: handleDetection,
                onCameraNotAllowed: () => {
                  state.error.value = MESSAGES.CAMERA_DENIED;
                },
              };

              detector = await MitsukeLive.createDetector(
                "video",
                "canvas",
                MODEL_PATHS.modelPath,
                MODEL_PATHS.metadataPath,
                options
              );
              state.isDetecting.value = true;
            } catch (err) {
              console.error("Detection initialization failed:", err);
            }
          };

          // Start/stop detection
          const toggleDetection = () => {
            if (!detector) return;

            if (state.isDetecting.value) {
              detector.pause();
              state.isDetecting.value = false;
              state.status.value = MESSAGES.PAUSED;
              state.detectionInfo.value = null;
            } else {
              detector.resume();
              state.isDetecting.value = true;
              state.status.value = MESSAGES.READY;
            }
          };

          onMounted(initDetector);
          onUnmounted(() => {
            if (detector) {
              detector.dispose();
            }
          });

          return {
            ...state,
            toggleDetection,
          };
        },

        template: `
          <div class="app">
            <div class="camera">
              <video id="video" class="camera__video" autoplay muted playsinline></video>
              <canvas id="canvas" class="camera__canvas"></canvas>
            </div>

            <div class="message">
              <div :class="{ status: !error, error: error }">
                {{ error || status }}
              </div>
            </div>

            <div class="controls">
              <button
                class="controls__btn"
                @click="toggleDetection"
                :title="isDetecting ? 'Stop Detection' : 'Start Detection'"
              >
                <i :class="isDetecting ? 'mdi mdi-pause' : 'mdi mdi-play'"></i>
              </button>
            </div>

            <div class="info" v-if="detectionInfo">
              <div class="info__header">Detection Info</div>
              <div class="info__detection">
                <div class="info__item">
                  <span class="info__label">Score:</span>
                  <span class="info__value monospace">{{ detectionInfo.score }}%</span>
                </div>
                <div class="info__item">
                  <span class="info__label">BBox:</span>
                  <span class="info__value monospace">[{{ detectionInfo.box.join(', ') }}]</span>
                </div>
                <div class="info__item">
                  <span class="info__label">Center:</span>
                  <span class="info__value monospace">({{ detectionInfo.centerX }}, {{ detectionInfo.centerY }})</span>
                </div>
              </div>
            </div>
          </div>
        `,
      };

      createApp(DetectionApp).mount("#app");
    </script>
  </body>
</html>
